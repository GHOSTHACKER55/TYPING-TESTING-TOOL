<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anonymous Shadows Typing Test</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; background:#0d1117; color:#c9d1d9; margin:0; padding:0; }
  h1 { text-align:center; color:#ff7b72; margin:20px 0; }
  .container { width:95%; max-width:500px; margin:0 auto; padding:10px; }
  .sentence { background:#161b22; color:#58a6ff; padding:15px; border-radius:8px; font-size:18px; margin:15px 0; user-select:none; }
  input, textarea { width:100%; padding:10px; border-radius:5px; border:none; margin:5px 0; font-size:16px; }
  input { background:#161b22; color:#c9d1d9; }
  button { background:#238636; color:white; padding:10px; border:none; width:100%; border-radius:5px; cursor:pointer; font-size:16px; margin:10px 0; }
  button:hover { background:#2ea043; }
  .result { text-align:center; font-size:20px; color:#ff7b72; margin-top:15px; }
  .admin-button { background:#ff7b72; }
</style>
</head>
<body>
<h1>Anonymous Shadows Typing Test</h1>
<div class="container">

  <div class="sentence" id="sentence">Loading sentence...</div>
  <input type="text" id="typedInput" placeholder="Start typing here..." autocomplete="off" />
  <div class="result" id="speed">Speed: 0%</div>

  <button id="restartBtn">Next Sentence</button>
  <a href="https://admin-panel-mu-sable.vercel.app/" target="_blank">
    <button class="admin-button">Open Admin Panel</button>
  </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-messaging-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCtjMyazrVnGFRASQOGjqeR_U9novXC15k",
    authDomain: "anonymous-shadows.firebaseapp.com",
    projectId: "anonymous-shadows",
    storageBucket: "anonymous-shadows.appspot.com",
    messagingSenderId: "939891243370",
    appId: "1:939891243370:web:8db01f36d0afa9a58b8d13",
    vapidKey: "BPRhIQxTwlYR0K3pZD8QomSlZFBbZz4txXmbH-i0Q5oWaf54VTVjyZ4TqsfpBgac2IMOpeOY59DMb6lsoiMewSU"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messaging = firebase.messaging();

// Sentences for typing
const sentences = [
    "How are you today?",
    "Typing speed tests are fun!",
    "Anonymous Shadows is the best tool.",
    "Practice makes perfect in typing.",
    "The quick brown fox jumps over the lazy dog.",
    "Push notifications keep users engaged.",
    "Always secure your Firebase app.",
    "Learning coding is an enjoyable journey."
];

let currentIndex = 0;
let startTime;

// Load first sentence
function loadSentence() {
    document.getElementById('typedInput').value = '';
    const sentenceDiv = document.getElementById('sentence');
    currentIndex = Math.floor(Math.random() * sentences.length);
    sentenceDiv.textContent = sentences[currentIndex];
    startTime = new Date().getTime();
    document.getElementById('speed').textContent = 'Speed: 0%';
}
loadSentence();

// Calculate typing speed
document.getElementById('typedInput').addEventListener('input', () => {
    const typed = document.getElementById('typedInput').value;
    const sentence = sentences[currentIndex];
    let correctChars = 0;
    for (let i = 0; i < typed.length; i++) {
        if (typed[i] === sentence[i]) correctChars++;
    }
    const percent = Math.floor((correctChars / sentence.length) * 100);
    document.getElementById('speed').textContent = `Speed: ${percent}%`;

    // Save typing session when finished
    if (typed === sentence) {
        const session = {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            sentence: sentence,
            typed: typed,
            wpm: percent
        };
        db.collection("typingSessions").add(session)
          .then(() => console.log("Session saved"))
          .catch(e => console.error(e));
    }
});

// Next sentence button
document.getElementById('restartBtn').addEventListener('click', loadSentence);

// Log user visit
db.collection("userVisits").add({
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    userAgent: navigator.userAgent,
    page: window.location.pathname
});

// FCM Token registration
async function registerFCM() {
    try {
        const permission = await Notification.requestPermission();
        if(permission === 'granted') {
            const token = await messaging.getToken({ vapidKey: firebaseConfig.vapidKey });
            await db.collection("notificationTokens").add({ token, uid: "user_" + Date.now() });
            console.log("FCM Token registered:", token);
        }
    } catch (e) { console.error("FCM Error:", e); }
}
registerFCM();
</script>
</body>
</html>