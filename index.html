<!DOCTYPE html>
<html>
<head>
    <title>Anonymous Shadows Web</title>
</head>
<body>
    <h1>Anonymous Shadows Typing Tool</h1>
    <p>Type the sentence below as fast as you can:</p>
    <div id="sentence">How are you? How is your day going?</div>
    <textarea id="typingArea" rows="4" cols="50"></textarea>
    <p id="speed">Typing speed will appear here.</p>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-messaging.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCtjMyazrVnGFRASQOGjqeR_U9novXC15k",
            authDomain: "anonymous-shadows.firebaseapp.com",
            projectId: "anonymous-shadows",
            storageBucket: "anonymous-shadows.firebasestorage.app",
            messagingSenderId: "939891243370",
            appId: "1:939891243370:web:8db01f36d0afa9a58b8d13",
            vapidKey: "YOUR_VAPID_KEY_HERE" // Replace with actual VAPID key
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        // Log user visit
        async function logUserVisit() {
            try {
                await addDoc(collection(db, "userVisits"), {
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent,
                    page: window.location.pathname
                });
            } catch (e) { console.error(e); }
        }
        logUserVisit();

        // Initialize FCM
        async function initializeFCM() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    const token = await getToken(messaging, { vapidKey: firebaseConfig.vapidKey });
                    console.log("FCM Token:", token);
                    await addDoc(collection(db, "notificationTokens"), { token, timestamp: serverTimestamp() });
                }
            } catch (err) { console.error(err); }
        }
        initializeFCM();

        // Typing tool logic
        const textarea = document.getElementById("typingArea");
        const sentence = document.getElementById("sentence").innerText;
        const speedDisplay = document.getElementById("speed");
        let startTime = null;

        textarea.addEventListener("input", () => {
            if (!startTime) startTime = new Date();
            if (textarea.value === sentence) {
                const endTime = new Date();
                const timeDiff = (endTime - startTime) / 1000; // seconds
                const words = sentence.split(" ").length;
                const wpm = Math.round((words / timeDiff) * 60);
                speedDisplay.innerText = "Your typing speed: " + wpm + " WPM";

                // Save typing session
                addDoc(collection(db, "typingSessions"), {
                    timestamp: serverTimestamp(),
                    speed: wpm,
                    sentence: sentence
                });
            }
        });
    </script>
</body>
</html>